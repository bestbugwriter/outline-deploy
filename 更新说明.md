# 更新说明

## 🎉 本次更新内容

### 1. 新增 RSS 服务套件
- **RSSHub** - RSS 源生成器 (172.16.0.90:1200)
- **Browserless** - 无头浏览器服务
- **FreshRSS** - RSS 阅读器 (172.16.0.92:80)

### 2. 配置重用机制（重要）
**核心改进**：`config.sh` 现在会自动重用 `deploy.conf` 中的已有密码，不会每次都重新生成。

```bash
# 之前：每次都重新生成
export POSTGRES_PASSWORD=$(randomString16)

# 现在：只在不存在时生成
setIfEmpty POSTGRES_PASSWORD "$(randomString16)"
```

**效果**：
- ✅ 多次执行密码保持一致
- ✅ 升级时旧密码自动保留
- ✅ 新服务密码自动生成

## 🚀 使用方法

### 全新部署
```bash
./deploy.sh service
```

### 已有环境升级
```bash
# 1. 备份配置（重要！）
cp deploy.conf deploy.conf.backup

# 2. 拉取新代码
git pull

# 3. 部署（自动重用旧密码）
./deploy.sh service
```

### 启用 RSS 服务
```bash
# 在 config.sh 中修改
export RSS_ENABLED=true

# 或在 deploy.conf 中添加
echo "RSS_ENABLED=true" >> deploy.conf

# 然后部署
./deploy.sh service
```

## 📋 配置重用原理

### 工作流程
1. `config.sh` 启动时检查 `deploy.conf` 是否存在
2. 如果存在，先加载已有配置
3. 使用 `setIfEmpty` 只为新变量生成值
4. `deploy.sh` 完成后保存配置到 `deploy.conf`

### 代码实现
```bash
# config.sh 开头
if [ -f "deploy.conf" ]; then
    echo "Found deploy.conf, loading existing configuration..."
    set -a
    source deploy.conf
    set +a
fi

# 条件设置函数
function setIfEmpty() {
    local var_name=$1
    local var_value=$2
    if [ -z "${!var_name}" ]; then
        export "$var_name=$var_value"
    fi
}
```

## 📝 配置说明

### 服务开关
```bash
MINIO_ENABLED=false    # Minio 对象存储
DRAWIO_ENABLED=false   # Draw.io 绘图
GRIST_ENABLED=false    # Grist 表格
RSS_ENABLED=false      # RSS 服务套件（新增）
```

### RSS 配置变量
```bash
# RSSHub
RSSHUB_IP=172.16.0.90
RSSHUB_PORT=1200
RSSHUB_ACCESS_KEY=<自动生成>

# Browserless
BROWSERLESS_IP=172.16.0.91
BROWSERLESS_PORT=3000

# FreshRSS
FRESHRSS_IP=172.16.0.92
FRESHRSS_ADMIN_USER=admin
FRESHRSS_ADMIN_PASSWORD=<自动生成>
FRESHRSS_DB_NAME=freshrss_db
FRESHRSS_DB_USER=freshrss_user
FRESHRSS_DB_PASSWORD=<自动生成>

# Telegram（可选）
TELEGRAM_SESSION=
TELEGRAM_TOKEN=
```

### 查看生成的密码
```bash
# 查看所有配置
cat deploy.conf

# 查看特定密码
grep FRESHRSS_ADMIN_PASSWORD deploy.conf
grep RSSHUB_ACCESS_KEY deploy.conf
```

## ⚠️ 重要提醒

1. **一定要备份 deploy.conf** - 包含所有密码
2. **不要提交 deploy.conf 到 git** - 已在 .gitignore 中
3. **升级前先备份配置文件**
4. **RSS 服务默认关闭**，需要设置 `RSS_ENABLED=true` 启用

## 🔧 常见问题

### Q: 如何重置某个密码？
```bash
# 编辑 deploy.conf，删除要重置的密码行
vim deploy.conf
# 删除: POSTGRES_PASSWORD=xxx

# 重新执行
source config.sh
./deploy.sh restart postgresql
```

### Q: 如何完全重新开始？
```bash
# 删除所有配置和数据
rm -f deploy.conf
rm -rf */data */logs

# 重新部署
./deploy.sh service
```

### Q: FreshRSS 无法连接数据库？
```bash
# 重启 PostgreSQL（会执行初始化脚本）
./deploy.sh restart postgresql

# 检查数据库是否创建
docker exec postgres psql -U postgres -c "\l" | grep freshrss
```

### Q: 如何配置 Telegram？
```bash
# 编辑 deploy.conf
vim deploy.conf

# 添加你的 Telegram 配置
TELEGRAM_SESSION=your_session_string
TELEGRAM_TOKEN=your_bot_token

# 重启 RSSHub
cd rss && docker compose restart rsshub
```

## 📊 文件变更

### 修改的文件
- `config.sh` - 添加配置重用逻辑和 RSS 配置
- `deploy.sh` - 添加 RSS 部署逻辑
- `postgresql/docker-compose.yml` - 添加 FreshRSS 环境变量
- `postgresql/init-db.sh` - 添加 FreshRSS 数据库创建
- `.gitignore` - 添加数据目录和 deploy.conf

### 新增的文件
- `rss/docker-compose.yml` - RSS 服务配置
- `rss/README.md` - RSS 服务说明
- `rss/快速开始.md` - RSS 快速开始指南

## 🧪 测试

### 验证配置重用
```bash
# 运行测试脚本
./test_idempotency.sh
```

### 手动测试
```bash
# 第一次执行
./deploy.sh service
grep POSTGRES_PASSWORD deploy.conf  # 记录密码

# 第二次执行
./deploy.sh service
grep POSTGRES_PASSWORD deploy.conf  # 应该相同
```

## 📦 RSS 服务详情

### 访问方式
- **RSSHub**: `http://172.16.0.90:1200`
  - 健康检查: `/healthz?key=<ACCESS_KEY>`
- **FreshRSS**: `http://172.16.0.92`
  - 用户名: `admin`
  - 密码: 查看 `deploy.conf`

### 数据持久化
- FreshRSS 数据: `rss/fr-data/`
- FreshRSS 扩展: `rss/fr-extensions/`

### 备份 RSS 数据
```bash
cd rss
tar czf rss-backup-$(date +%Y%m%d).tar.gz fr-data fr-extensions
```

---

**需要帮助？** 查看 `rss/README.md` 了解更多 RSS 服务详情。
